<h1>Clients</h1>
<br />
<div class="row">
  <div class="col-xs-6 col-sm-6">
    <%= form_tag records_path, :method => 'get', :class => "form-inline" do %>
      <%= text_field_tag :search, params[:search], :class => "input-lg", autofocus: true %>
      <%= submit_tag "Search", :name => nil, :class => "btn btn-default btn-lg", :style => "margin:0px 0px 10px 10px" %>
    <% end %>
  </div>

  <div class="col-xs-3 col-sm-3">
    <h4>Total Clients: <%= @records.count %></h4>
  </div>
  <div class="col-xs-3 col-sm-3">
    <%= link_to 'New Record', new_record_path, class: 'btn btn-default btn-lg btn-info pull-right', "data-no-turbolink"=>"true"  %>
  </div>
</div>

<% if @records.any? %>
<% else %>
  <p>No search results match your search: <%= params[:search] %>.</p>
<% end %>
<table class="table table-hover" id="records">
  <thead>
    <tr>
      <th><%= sortable "firstname", "Frist Name"%></th>
      <th><%= sortable "lastname", "Last Name" %></th>
      <!--<th><%= sortable "receivedate", " Age" %></th>-->
      <th><%= sortable "updated_at", "Updated" %></th>
      <th><%= sortable "progress", "Progress" %></th>
      <th><%= sortable "detailedprogress", "Detailed Progress" %></th> 
      <th><%= sortable "loanofficer_id", "Loan Officer" %></th>
      <th><%= sortable "processor_id", "Processor" %></th>
      <th><%= sortable "real_id", "Realtor" %></th>
      <% if current_user.profile.title == "master" %>
        <th colspan="1"></th>
      <% end %>
    </tr>
  </thead>

  <tbody> 
    <% @records.each do |record| %>
      <% if record.progress != "On Hold" and record.progress != "Completed" and record.progress != "Dropped" and record.progress != "Unknown" %>
      <% myrecdate = getupdated(record) || nil %>
        <% if !myrecdate.blank? %>
          <% if myrecdate.to_date >= Date.today-2 %>
            <% @followupwithme = "success" %> 
          <% elsif myrecdate.to_date >= Date.today-6 %>
            <% @followupwithme = "warning" %> 
          <% elsif myrecdate.to_date <= Date.today-7 %>
            <% @followupwithme = "danger" %> 
          <% else %>
            <% @followupwithme = "" %>
          <% end %>
        <% else %>
          <% @followupwithme = "" %> 
        <% end %>
        
        <%= content_tag :tr, class: "#{@followupwithme}" do -%> 

          <td><%= correctlink record, record.firstname %></td>
          <td><%= correctlink record, record.lastname %></td>
          <td>
            <%= time_ago_in_words(myrecdate) %>
          </td>
          <td><%= record.progress %></td>          
          <td><%= getpname record.detailedprogress %></td>
          <td><%= getname record.loanofficer_id %></td>
          <td><%= getname record.processor_id %></td>
          <td><%= getname record.real_id %></td>  
          <% if current_user.profile.title == "master" %>
            <td><%= link_to image_tag("trash.png", size: "18x20", alt: "Remove", "style"=>"padding:2px"), record, method: :delete, data: { confirm: 'Are you sure?' }, :class => 'btn btn-default btn-xs' %></td>
          <% end %>
        <% end -%>
      <% end %>
    <% end %>
  </tbody>
</table>

<br />
<br />
<br />
<hr />
<p onclick="showClosedTable()", class="btn btn-default btn-lg"> Inactive Client List</p>
<br>

<table class="table table-hover" id="deadrecords" style="visibility:hidden">
  <thead>
    <tr>
      <th><%= sortable "firstname", "Frist Name"%></th>
      <th><%= sortable "lastname", "Last Name" %></th>
      <th><%= sortable "updated_at", "updated_at" %></th>
      <th><%= sortable "progress", "Progress" %></th> 
      <th><%= sortable "detailedprogress", "Progress" %></th>       
      <th><%= sortable "loanofficer_id", "Loan Officer" %></th>
      <th><%= sortable "processor_id", "Processor" %></th>
      <th><%= sortable "real_id", "Realtor" %></th>
      <% if current_user.profile.title == "master" || current_user.profile.title == "admin" %>
        <th colspan="1"></th>
      <% end %>
    </tr>
  </thead>

  <tbody>
    <% @records.each do |record| %>
      <% if record.progress == "On Hold" or record.progress == "Completed" or record.progress == "Dropped" or record.progress == "Unknown" %>
       <!--<tr data-link="<%= edit_record_path(record) %>">-->
        <tr>
          <td><%= correctlink record, record.firstname %></td>
          <td><%= correctlink record, record.lastname %></td>
          <td><%= time_ago_in_words(getupdated record) %></td>
          <td><%= record.progress %></td>      
          <td><%= getpname record.detailedprogress %></td>
          <td><%= getname record.loanofficer_id %></td>
          <td><%= getname record.processor_id %></td>
          <td><%= getname record.real_id %></td>  
          <% if current_user.profile.title == "admin" || current_user.id == record.loanofficer_id || current_user.id == record.processor_id || current_user.profile.title == "master" %>
            <td><%= link_to 'Destroy', record, method: :delete, data: { confirm: 'Are you sure?' }, :class => 'btn btn-default btn-xs' %></td>
          <% end %>
        </tr>
      <% end %>
    <% end %>
  </tbody>
</table>

<% if current_user.profile.title == "admin" || current_user.profile.title == "master" %>
<br />
<br />
<br />
<hr>

  <h2>Backup</h2>
  <br />
  <div class="row">
    <div class="col-xs-4 col-sm-4">
    <h3>Export Records</h3>
      <%= link_to "To CSV File", records_path(format: "csv"), :class => 'btn btn-default btn' %>

    </div>
    <div class="col-xs-4 col-sm-4">
      <h3>Import Records</h3>
      <%= form_tag import_records_path, multipart: true do %>
        <%= file_field_tag :file, :class => 'btn btn-default btn' %><br />
        <%= submit_tag "Import", :class => 'btn btn-default btn' %>
      <% end %>
    </div>
  </div>
<% end %>

<script>
function showClosedTable() {
  if (document.getElementById('deadrecords').style.visibility=='hidden'){
    document.getElementById('deadrecords').style.visibility='visible';
  } else {
    document.getElementById('deadrecords').style.visibility='hidden';
  }

    return false;
}
</script>
<br />